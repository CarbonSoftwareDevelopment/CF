<app-nav></app-nav>
<div class="container">
  <div class="row">
    <div class="col-12 text-center">
      <br>
      <h3 class="routeHeader">{{showRoute()}}</h3>
    </div>
    <br>
  </div>
  <div class="row" style="margin-top: 20px">
    <div class="col-lg-8 col-md-10 col-sm-12 offset-md-1 offset-lg-2">
      <mat-accordion>
        <mat-expansion-panel hideToggle>
          <mat-expansion-panel-header>
            <mat-panel-title>
              Milestones Setup
            </mat-panel-title>
            <mat-panel-description>
              Add Milestone Lists
              <i class="fas fa-tasks"></i>
            </mat-panel-description>
          </mat-expansion-panel-header>
          <div class="row">
            <div class="col-10 offset-1" style="margin-bottom: 10px;">
              <form class="MilestoneListForm" [formGroup]="MilestoneListForm">
                <mat-accordion>
                  <mat-expansion-panel hideToggle class="msListPanel" formArrayName="list"
                                       *ngFor="let l of list.controls; let i = index" [expanded]="i + 1 === list.length">
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        {{ l.get('title').value ? l.get('title').value : 'List ' + (i + 1) }}
                      </mat-panel-title>
                      <mat-panel-description>
                        {{ getMilestones(i).length }} Milestones
                        <i class="fas fa-trash-alt float-right deleteBtn"
                           (click)="removeMilestoneList($event, i)"></i>
                      </mat-panel-description>
                    </mat-expansion-panel-header>
                    <div [formGroupName]="i" (change)="onListChange(i)">
                      <mat-form-field class="innerFormFields">
                        <input matInput placeholder="List title" formControlName="title" required>
                        <mat-error *ngIf="l.get('title').hasError('required')">
                          List title is required.
                        </mat-error>
                      </mat-form-field>
                      <mat-accordion>
                        <mat-expansion-panel hideToggle class="msPanel" formArrayName="milestones"
                                           *ngFor="let m of getMilestones(i).controls; let k = index" [expanded]="k + 1 === getMilestones(i).length">
                        <mat-expansion-panel-header>
                          <mat-panel-title>
                            {{ m.get('name').value ? m.get('name').value : 'Milestone' }}
                          </mat-panel-title>
                          <mat-panel-description>
                            {{ k + 1 }}
                            <i class="fas fa-trash-alt float-right deleteBtn" *ngIf="getMilestones(i).length > 1"
                               (click)="removeMilestone($event, i, k)"></i>
                          </mat-panel-description>
                        </mat-expansion-panel-header>
                        <div class="row" [formGroupName]="k" (change)="onMilestoneChange(i , k)">
                          <mat-form-field class="innerFormFields col-8">
                            <input matInput placeholder="Milestone Name" formControlName="name" required>
                            <mat-error *ngIf="m.get('name').hasError('required')">
                              Milestone Name is required.
                            </mat-error>
                          </mat-form-field>
                          <mat-form-field class="innerFormFields col-4">
                            <input matInput type="number" placeholder="Milestone Number" formControlName="number" required>
                          </mat-form-field>
                          <mat-form-field class="innerFormFields col-12" appearance="outline">
                            <mat-label>Email Notification Message</mat-label>
                            <textarea matInput
                                      placeholder="Dear *contact_name* your property *property_description* has been registered at *deeds_office* please contact me *my_name* for any other queries."
                                      formControlName="emailMessage" required rows="4"></textarea>
                            <mat-error>Email Message is required.</mat-error>
                          </mat-form-field>
                          <div class="col-12">
                            <span style="color: lightgray">Insert Placeholders</span><br>
                            <mat-chip-list>
                              <mat-chip
                                (click)="insertNoti($event, i, k, ' *contact_name*','emailMessage'); onMilestoneChange(i,k); onListChange(i)">
                                Contact's Name
                              </mat-chip>
                              <mat-chip
                                (click)="insertNoti($event, i, k, ' *property_description*', 'emailMessage'); onMilestoneChange(i,k); onListChange(i)">
                                Prop Description
                              </mat-chip>
                              <mat-chip
                                (click)="insertNoti($event, i, k, ' *deeds_office*', 'emailMessage'); onMilestoneChange(i,k); onListChange(i)">
                                Deeds Office
                              </mat-chip>
                              <mat-chip
                                (click)="insertNoti($event, i, k, ' *my_name*', 'emailMessage'); onMilestoneChange(i,k); onListChange(i)">
                                My Name
                              </mat-chip>
                              <mat-chip
                                (click)="insertNoti($event, i, k, ' *sec_names*', 'emailMessage'); onMilestoneChange(i,k); onListChange(i)">
                                Secretary name/s
                              </mat-chip>
                              <mat-chip
                                (click)="insertNoti($event, i, k, ' *sec_emails*', 'emailMessage'); onMilestoneChange(i,k); onListChange(i)">
                                Secretary email/s
                              </mat-chip>
                              <mat-chip
                                (click)="insertNoti($event, i, k, ' *file_ref*', 'emailMessage'); onMilestoneChange(i,k); onListChange(i)">
                                File Reference
                              </mat-chip>
                            </mat-chip-list>
                          </div>
                          <mat-form-field class="innerFormFields col-12" appearance="outline">
                            <mat-label>SMS Notification Message</mat-label>
                            <textarea matInput
                                      placeholder="Dear *contact_name* your property *property_description* has been registered at *deeds_office* please contact me *my_name* for any other queries."
                                      formControlName="smsMessage" required rows="4"></textarea>
                            <mat-error>SMS Message is required.</mat-error>
                          </mat-form-field>
                          <div class="col-12">
                            <span style="color: lightgray">Insert Placeholders</span><br>
                            <mat-chip-list>
                              <mat-chip
                                (click)="insertNoti($event, i, k, ' *contact_name*','smsMessage'); onMilestoneChange(i,k); onListChange(i)">
                                Contact's Name
                              </mat-chip>
                              <mat-chip
                                (click)="insertNoti($event, i, k, ' *property_description*', 'smsMessage'); onMilestoneChange(i,k); onListChange(i)">
                                Prop Description
                              </mat-chip>
                              <mat-chip
                                (click)="insertNoti($event, i, k, ' *deeds_office*', 'smsMessage'); onMilestoneChange(i,k); onListChange(i)">
                                Deeds Office
                              </mat-chip>
                              <mat-chip
                                (click)="insertNoti($event, i, k, ' *my_name*', 'smsMessage'); onMilestoneChange(i,k); onListChange(i)">
                                My Name
                              </mat-chip>
                              <mat-chip
                                (click)="insertNoti($event, i, k, ' *sec_names*', 'smsMessage'); onMilestoneChange(i,k); onListChange(i)">
                                Secretary name/s
                              </mat-chip>
                              <mat-chip
                                (click)="insertNoti($event, i, k, ' *sec_emails*', 'smsMessage'); onMilestoneChange(i,k); onListChange(i)">
                                Secretary email/s
                              </mat-chip>
                              <mat-chip
                                (click)="insertNoti($event, i, k, ' *file_ref*', 'smsMessage'); onMilestoneChange(i,k); onListChange(i)">
                                File Reference
                              </mat-chip>
                            </mat-chip-list>
                          </div>
                          <div class="col-12">
                            <mat-checkbox (change)="onMilestoneChange(i, k); onListChange(i)" formControlName="sendEmail">
                              Email to all parties</mat-checkbox>
                          </div>
                          <div class="col-12">
                            <mat-checkbox (change)="onMilestoneChange(i, k); onListChange(i)" formControlName="sendSMS">
                              SMS to all parties</mat-checkbox>
                          </div>
                          <div class="col-12">
                            <mat-checkbox (change)="onMilestoneChange(i, k); onListChange(i)" formControlName="alwaysAsk">
                              Always Ask</mat-checkbox>
                          </div>
                        </div>
                      </mat-expansion-panel>
                      </mat-accordion>
                    </div>
                    <div class="btn-group" role="group" aria-label="action buttons" style="margin-top: 5px;">
                      <button (click)="addMilestone(i)" class="btn btn-outline-secondary btn-sm" color="primary"
                               [disabled]="!(l.get('title').valid && MilestoneListForm.valid)"><i class="fas fa-plus"></i> Add Milestone
                      </button>
                      <button class="btn btn-primary btn-sm saveButton" color="primary" [disabled]="!MilestoneListForm.valid" (click)="submitMilestones(i)">
                        <span *ngIf="!(loaderService.isLoading | async)"><i class="far fa-save"></i> Save</span>
                        <i *ngIf="loaderService.isLoading | async" class="fas fa-spinner fa-spin"></i>
                      </button>
                    </div>
                  </mat-expansion-panel>
                </mat-accordion>
              </form>
            </div>
          </div>
          <button (click)="addMilestoneList()" [disabled]="!MilestoneListForm.valid" class="btn btn-outline-primary btn-xs" color="primary">
            <i class="fas fa-plus"></i> Add Milestone List
          </button>
        </mat-expansion-panel>
        <mat-expansion-panel hideToggle>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <!--File Properties--> Deeds Offices
            </mat-panel-title>
            <mat-panel-description>
              <!--Configure File Properties and types.--> Add and remove deeds offices
              <i class="fas fa-cog"></i>
            </mat-panel-description>
          </mat-expansion-panel-header>
          <div class="row">
            <div class="col-10 offset-1" style="margin-bottom: 10px;">
              <form class="PropertiesForm" [formGroup]="PropertiesForm">
                <mat-accordion>
                  <!--<mat-expansion-panel hideToggle class="msListPanel">
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        Property Types
                      </mat-panel-title>
                      <mat-panel-description>
                        Manage Property Types
                        <i class="fas fa-home float-right"></i>
                      </mat-panel-description>
                    </mat-expansion-panel-header>
                    <div class="propertiesPanelBody">
                      <mat-accordion>
                        <mat-expansion-panel class="msPanel" hideToggle [expanded]="true"
                                             *ngFor="let p of propertyTypes.controls; let i = index" formArrayName="propertyTypes">
                          <mat-expansion-panel-header>
                            <mat-panel-description>
                              {{p.get('name').value ? p.get('name').value : 'Property Type ' + (i+1)}}
                              <i class="fas fa-trash-alt float-right deleteBtn" (click)="removePropertyType($event, i)"></i>
                            </mat-panel-description>
                          </mat-expansion-panel-header>
                          <div [formGroupName]="i">
                            <mat-form-field class="innerFormFields">
                              <input (change)="onPropTypeChange(i)" matInput placeholder="Property Type" formControlName="name" required>
                              <mat-error>
                                Property Type is required.
                              </mat-error>
                            </mat-form-field>
                          </div>
                        </mat-expansion-panel>
                      </mat-accordion>
                    </div>
                    <button *ngIf="propertyTypes.valid" (click)="addPropertyType()" class="btn btn-outline-secondary btn-sm" color="primary" style="margin-top: 5px;">
                      <i class="fas fa-plus"></i> Add Property Type
                    </button>
                  </mat-expansion-panel>
                  <mat-expansion-panel hideToggle class="msListPanel">
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        Cause of Action Types
                      </mat-panel-title>
                      <mat-panel-description>
                        Manage Action Types
                        <i class="fas fa-exclamation"></i>
                      </mat-panel-description>
                    </mat-expansion-panel-header>
                    <div class="propertiesPanelBody">
                      <mat-accordion>
                        <mat-expansion-panel class="msPanel" hideToggle [expanded]="true"
                                             *ngFor="let at of actionTypes.controls; let i = index" formArrayName="actionTypes">
                          <mat-expansion-panel-header>
                            <mat-panel-description>
                              {{at.get('name').value ? at.get('name').value : 'Action Type ' + (i+1)}}
                              <i class="fas fa-trash-alt float-right deleteBtn" (click)="removeActionType($event, i)"></i>
                            </mat-panel-description>
                          </mat-expansion-panel-header>
                          <div [formGroupName]="i">
                            <mat-form-field class="innerFormFields">
                              <input (change)="onActionTypeChange(i)" matInput placeholder="Action type" formControlName="name" required>
                              <mat-error>
                                Action Type is required.
                              </mat-error>
                            </mat-form-field>
                          </div>
                        </mat-expansion-panel>
                      </mat-accordion>
                    </div>
                    <button *ngIf="actionTypes.valid" (click)="addActionType()" class="btn btn-outline-secondary btn-sm" color="primary" style="margin-top: 5px;">
                      <i class="fas fa-plus"></i> Add Action Type
                    </button>
                  </mat-expansion-panel>-->
                  <mat-expansion-panel hideToggle class="msListPanel">
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        Deeds Offices
                      </mat-panel-title>
                      <mat-panel-description>
                        Manage Deeds Offices
                        <i class="fas fa-building"></i>
                      </mat-panel-description>
                    </mat-expansion-panel-header>
                    <div class="propertiesPanelBody">
                      <mat-accordion>
                        <mat-expansion-panel class="msPanel" hideToggle [expanded]="i + 1 === deedsOffices.length"
                                             *ngFor="let d of deedsOffices.controls; let i = index" formArrayName="deedsOffices">
                          <mat-expansion-panel-header>
                            <mat-panel-description>
                              {{d.get('name').value ? d.get('name').value : 'Deeds Office ' + (i+1)}}
                              <i class="fas fa-trash-alt float-right deleteBtn" (click)="removeDeedsOffice($event, i)"></i>
                            </mat-panel-description>
                          </mat-expansion-panel-header>
                          <div [formGroupName]="i">
                            <mat-form-field class="innerFormFields">
                              <input (change)="onDeedsOffChange(i)" matInput placeholder="Deeds Office" formControlName="name" required>
                              <mat-error>
                                Deeds Office is required.
                              </mat-error>
                            </mat-form-field>
                          </div>
                        </mat-expansion-panel>
                      </mat-accordion>
                    </div>
                    <button [disabled]="!deedsOffices.valid" (click)="addDeedsOffice()" class="btn btn-outline-secondary btn-sm" color="primary" style="margin-top: 5px;">
                      <i class="fas fa-plus"></i> Add Deeds Office
                    </button>
                  </mat-expansion-panel>
                </mat-accordion>
              </form>
            </div>
          </div>
          <mat-action-row>
            <button (click)="submitProperties()" class="btn btn-primary btn-md" color="primary">
              <span *ngIf="!(loaderService.isLoading | async)"><i class="far fa-save"></i> Save</span>
              <i *ngIf="loaderService.isLoading | async" class="fas fa-spinner fa-spin"></i>
            </button>
          </mat-action-row>
        </mat-expansion-panel>
        <mat-expansion-panel hideToggle>
          <mat-expansion-panel-header>
            <mat-panel-title>
              Contacts
            </mat-panel-title>
            <mat-panel-description>
              Manage Contact list
              <i class="fas fa-id-card-alt"></i>
            </mat-panel-description>
          </mat-expansion-panel-header>
          <div class="row">
            <div class="col-10 offset-1" style="margin-bottom: 10px;">
              <form class="ContactsForm" [formGroup]="ContactsForm">
                <mat-accordion>
                  <mat-expansion-panel hideToggle class="msListPanel" [expanded]="i + 1 === contacts.length"
                                       *ngFor="let c of contacts.controls; let i = index" formArrayName="contacts">
                    <mat-expansion-panel-header>
                      <mat-panel-description>
                        {{c.get('name').value ? c.get('name').value : 'Contact ' + (i+1)}}
                        <i class="fas fa-trash-alt float-right deleteBtn" (click)="removeContact($event, i)"></i>
                      </mat-panel-description>
                    </mat-expansion-panel-header>
                    <div [formGroupName]="i" (change)="onContactChange(i)">
                      <mat-form-field class="innerFormFields">
                        <mat-select (valueChange)="onContactChange(i)" placeholder="Contact's title" formControlName="title" required>
                          <mat-option value="Mr.">
                            Mr.
                          </mat-option>
                          <mat-option value="Mrs.">
                            Mrs.
                          </mat-option>
                          <mat-option value="Ms.">
                            Ms.
                          </mat-option>
                          <mat-option value="Dr.">
                            Dr.
                          </mat-option>
                          <mat-option value="Prof.">
                            Prof.
                          </mat-option>
                          <mat-option value="Adv.">
                            Adv.
                          </mat-option>
                        </mat-select>
                        <mat-error>
                          Contact title is required.
                        </mat-error>
                      </mat-form-field>
                      <br>
                      <mat-form-field class="innerFormFields">
                        <input matInput placeholder="Name" formControlName="name" required>
                        <mat-error>
                          Contact name is required.
                        </mat-error>
                      </mat-form-field>
                      <br>
                      <mat-form-field class="innerFormFields">
                        <input matInput placeholder="Surname" formControlName="surname" required>
                        <mat-error>
                          Contact surname is required.
                        </mat-error>
                      </mat-form-field>
                      <br>
                      <mat-form-field class="innerFormFields">
                        <input matInput placeholder="Cell number" formControlName="cell" required>
                        <mat-error *ngIf="c.get('cell').hasError('required')">
                          Cell number is required.
                        </mat-error>
                        <mat-error *ngIf="c.get('cell').hasError('length')">
                          A valid cell must be 10 digits long.
                        </mat-error>
                        <mat-error *ngIf="c.get('cell').hasError('numbers')">
                          A valid cell must consist of only numbers.
                        </mat-error>
                        <mat-error *ngIf="c.get('cell').hasError('firstZero')">
                          A valid cell must start with a 0.
                        </mat-error>
                      </mat-form-field>
                      <br>
                      <mat-form-field class="innerFormFields">
                        <input (change)="checkUniquenessValidator(i)" type="email" matInput placeholder="Email address" formControlName="email">
                        <mat-error *ngIf="c.get('email').hasError('email')">
                          Email must be a valid email address.
                        </mat-error>
                        <mat-error *ngIf="c.get('email').hasError('emailNotUnique')">
                          You already have a contact with this email.
                        </mat-error>
                      </mat-form-field>
                      <br>
                      <mat-form-field class="innerFormFields">
                        <mat-select (valueChange)="onContactChange(i)" placeholder="Contact type" formControlName="type" required>
                          <mat-option value="Buyer">
                            Buyer
                          </mat-option>
                          <mat-option value="Seller">
                            Seller
                          </mat-option>
                          <mat-option value="Agent">
                            Agent
                          </mat-option>
                        </mat-select>
                        <mat-error>
                          Contact type is required.
                        </mat-error>
                      </mat-form-field>
                      <br>
                      <div class="btn-group" role="group" aria-label="action buttons" style="margin-top: 5px;">
                        <button class="btn btn-primary btn-sm saveButton" color="primary"
                                [disabled]="!contacts.at(i).valid || (loaderService.isLoading | async) || contacts.at(i).get('updatedBy').value === 'existing'" (click)="submitContact(i)">
                          <span *ngIf="!(loaderService.isLoading | async)"><i class="far fa-save"></i> Save</span>
                          <i *ngIf="loaderService.isLoading | async" class="fas fa-spinner fa-spin"></i>
                        </button>
                      </div>
                    </div>
                  </mat-expansion-panel>
                </mat-accordion>
              </form>
            </div>
          </div>
          <button [disabled]="!ContactsForm.valid" class="btn btn-outline-primary btn-sm" color="primary" (click)="addContact()">
            <i class="fas fa-plus"></i> Add Contact
          </button>
        </mat-expansion-panel>
        <mat-expansion-panel hideToggle *ngIf="iAmAdmin()">
          <mat-expansion-panel-header>
            <mat-panel-title>
              Users
            </mat-panel-title>
            <mat-panel-description>
              Manage Users
              <i class="fas fa-users"></i>
            </mat-panel-description>
          </mat-expansion-panel-header>
          <div class="row">
            <div class="col-10 offset-1" style="margin-bottom: 10px;">
              <form class="UsersForm" [formGroup]="UsersForm">
                <mat-accordion>
                  <mat-expansion-panel hideToggle class="msListPanel" [expanded]="i + 1 === users.length"
                                       *ngFor="let u of users.controls; let i = index" formArrayName="users">
                    <mat-expansion-panel-header>
                      <mat-panel-description>
                        {{u.get('name').value ? u.get('name').value + ' ' + u.get('surname')?.value : 'User ' + (i+1)}}
                        <i class="fas fa-trash-alt float-right deleteBtn" (click)="removeUser($event, i)"></i>
                      </mat-panel-description>
                    </mat-expansion-panel-header>
                    <div [formGroupName]="i" (change)="onUserChange(i)">
                      <mat-form-field class="innerFormFields">
                        <input matInput placeholder="Name" formControlName="name" required>
                        <mat-error>
                          User name is required.
                        </mat-error>
                      </mat-form-field>
                      <br>
                      <mat-form-field class="innerFormFields">
                        <input matInput placeholder="Surname" formControlName="surname" required>
                        <mat-error>
                          User surname is required.
                        </mat-error>
                      </mat-form-field>
                      <br>
                      <mat-form-field class="innerFormFields">
                        <input matInput placeholder="Cell number" formControlName="cell" required>
                        <mat-error *ngIf="u.get('cell').hasError('required')">
                          Cell number is required.
                        </mat-error>
                        <mat-error *ngIf="u.get('cell').hasError('length')">
                          A valid cell must be 10 digits long.
                        </mat-error>
                        <mat-error *ngIf="u.get('cell').hasError('numbers')">
                          A valid cell must consist of only numbers.
                        </mat-error>
                        <mat-error *ngIf="u.get('cell').hasError('firstZero')">
                          A valid cell must start with a 0.
                        </mat-error>
                      </mat-form-field>
                      <br>
                      <mat-form-field class="innerFormFields">
                        <input type="email" matInput placeholder="Email address" formControlName="email" required>
                        <mat-error *ngIf="u.get('email').hasError('required')">
                          Email address is required.
                        </mat-error>
                        <mat-error *ngIf="u.get('email').hasError('email')">
                          Email must be a valid email address.
                        </mat-error>
                        <mat-error *ngIf="u.get('email').hasError('emailNotUnique')">
                          You already have a user with this email.
                        </mat-error>
                      </mat-form-field>
                      <br>
                      <div class="btn-group" role="group" aria-label="action buttons" style="margin-top: 5px;">
                        <button class="btn btn-primary btn-sm saveButton" color="primary" [disabled]="!users.at(i).valid || (loaderService.isLoading | async) || users.at(i).get('updatedBy').value === 'existing'" (click)="submitUser(i)">
                          <span *ngIf="!(loaderService.isLoading | async)"><i class="far fa-save"></i> Save</span>
                          <i *ngIf="loaderService.isLoading | async" class="fas fa-spinner fa-spin"></i>
                        </button>
                      </div>
                    </div>
                  </mat-expansion-panel>
                </mat-accordion>
              </form>
            </div>
          </div>
          <button [disabled]="!ContactsForm.valid || (loaderService.isLoading | async)" class="btn btn-outline-primary btn-sm" (click)="addUser()" color="primary"><i class="fas fa-plus"></i> Add User</button>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
  </div>
</div>
